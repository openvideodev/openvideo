<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Render</title>
    <script type="importmap">
        {
            "imports": {
                "openvideo": "/node_modules/openvideo/dist/index.es.js"
            }
        }
    </script>
</head>

<body>
    <div id="status">Initializing...</div>
    <script type="module">
        import { Compositor } from 'openvideo';

        async function renderVideo() {
            try {
                const statusEl = document.getElementById('status');

                // Get the JSON configuration injected by Playwright
                const jsonConfig = window.RENDER_CONFIG;

                if (!jsonConfig) {
                    throw new Error('No render configuration provided');
                }

                statusEl.textContent = 'Creating compositor...';

                // Get settings from JSON or use defaults
                const settings = jsonConfig.settings || {};
                const compositorOpts = {
                    width: settings.width || 1280,
                    height: settings.height || 720,
                    fps: settings.fps || 30,
                    bgColor: settings.bgColor || '#000000',
                };

                if (settings.videoCodec) {
                    compositorOpts.videoCodec = settings.videoCodec;
                }
                if (settings.bitrate) {
                    compositorOpts.bitrate = settings.bitrate;
                }
                if (settings.audio === false) {
                    compositorOpts.audio = false;
                }
                if (settings.metaDataTags) {
                    compositorOpts.metaDataTags = settings.metaDataTags;
                }

                // Create compositor
                const compositor = new Compositor(compositorOpts);
                await compositor.initPixiApp();

                // Set up progress reporting
                compositor.on('OutputProgress', (progress) => {
                    statusEl.textContent = `Rendering: ${Math.round(progress * 100)}%`;

                    // Report progress to Node.js
                    if (window.__reportProgress) {
                        window.__reportProgress(progress);
                    }
                });

                compositor.on('error', (err) => {
                    console.error('Compositor error:', err);
                    statusEl.textContent = `Error: ${err.message}`;
                    window.renderError = err.message;
                });

                statusEl.textContent = 'Loading clips from JSON...';

                // Load from JSON
                await compositor.loadFromJSON(jsonConfig);

                statusEl.textContent = 'Starting render...';

                // Start rendering
                const stream = compositor.output();
                const blob = await new Response(stream).blob();

                // Convert blob to base64 for Playwright to save
                const reader = new FileReader();
                reader.onloadend = () => {
                    window.renderComplete = true;
                    window.renderBlobBase64 = reader.result.split(',')[1]; // Remove data URL prefix
                    statusEl.textContent = 'Render complete!';
                };
                reader.readAsDataURL(blob);

            } catch (error) {
                console.error('Render error:', error);
                document.getElementById('status').textContent = `Error: ${error.message}`;
                window.renderError = error.message;
            }
        }

        renderVideo();
    </script>
</body>

</html>